<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>SceneCraft AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to right, #1e3a8a, #4f46e5); }
  </style>
</head>
<body class="text-gray-100 relative">
  <!-- Auth Controls in Corner -->
  <div class="absolute top-4 right-4 space-x-2">
    <button id="showSignupBtn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-full shadow hover:bg-green-600 transition" title="Sign up with SceneCraft">
      Sign Up
    </button>
    <button id="googleSignInBtn" class="bg-white text-indigo-800 font-semibold py-2 px-4 rounded-full shadow hover:bg-gray-100 transition" title="Sign in with Google">
      Sign in with Google
    </button>
    <button id="signOutBtn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-full shadow hover:bg-red-600 transition hidden" title="Sign out">
      Sign Out
    </button>
  </div>

  <!-- Signup Form Modal -->
  <div id="signupForm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-indigo-900 p-6 rounded-lg shadow-lg w-80">
      <h2 class="text-xl text-yellow-400 mb-4">Create an Account</h2>
      <input id="signupEmail" type="email" placeholder="Email"
             class="w-full p-3 rounded-md bg-indigo-800 placeholder-gray-400 text-gray-100 border border-indigo-700 focus:outline-none mb-3"/>
      <input id="signupPassword" type="password" placeholder="Password"
             class="w-full p-3 rounded-md bg-indigo-800 placeholder-gray-400 text-gray-100 border border-indigo-700 focus:outline-none mb-4"/>
      <button id="signupSubmitBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg mb-3 transition">
        Register
      </button>
      <div class="text-center mb-3 text-indigo-200">or</div>
      <button id="googleSignUpBtn" class="w-full bg-white text-indigo-800 font-semibold py-2 rounded-lg shadow hover:bg-gray-100 transition">
        Sign up with Google
      </button>
      <button id="closeSignupBtn" class="mt-4 w-full text-sm text-indigo-400 hover:text-white">Cancel</button>
    </div>
  </div>

  <div class="max-w-3xl mx-auto p-6 pt-20">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-extrabold text-yellow-400 mb-2">SceneCraft AI</h1>
      <p class="text-md text-indigo-100">Cinematic Scene Analyzer &amp; Creative Mentor</p>
    </div>

    <textarea id="sceneInput" rows="8" placeholder="Paste your scene here..."
      class="w-full p-4 border border-indigo-500 bg-indigo-900 placeholder-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-yellow-400 text-gray-100 mb-4"></textarea>

    <div class="flex flex-col gap-3 mb-4">
      <label class="inline-flex items-center">
        <input type="checkbox" id="agreeCheckbox" class="form-checkbox h-5 w-5 text-yellow-400 bg-indigo-700">
        <span class="ml-2 text-sm text-indigo-100">I agree to the
          <a href="https://api.scenecraft-ai.com/terms" target="_blank" class="text-yellow-300 underline">Terms & Conditions</a>
        </span>
      </label>
      <label class="inline-flex items-center">
        <input type="checkbox" id="saveCheckbox" class="form-checkbox h-5 w-5 text-yellow-400 bg-indigo-700">
        <span class="ml-2 text-sm text-indigo-100">Save this analysis to my Dashboard</span>
      </label>
    </div>

    <button id="analyzeBtn"
      class="w-full bg-yellow-400 hover:bg-yellow-500 text-indigo-900 font-semibold py-3 px-6 rounded-xl shadow-lg transition-all duration-300">
      Analyze Scene
    </button>

    <div id="output"
         class="mt-6 bg-indigo-800 border border-yellow-400 rounded-lg p-4 text-sm whitespace-pre-wrap shadow-md hidden text-gray-100">
    </div>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC3WTOkOzUogOvFDEI6IhRsN0aJ0rezDqs",
      authDomain: "scenecraft-ai-30fae.firebaseapp.com",
      projectId: "scenecraft-ai-30fae",
      storageBucket: "scenecraft-ai-30fae.firebasestorage.app",
      messagingSenderId: "989462026132",
      appId: "1:989462026132:web:07920dffac54869ed62181",
      measurementId: "G-SZQBPND2CN"
    };

    // Initialize Firebase
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // UI elements
    const showSignupBtn   = document.getElementById("showSignupBtn");
    const signupForm      = document.getElementById("signupForm");
    const closeSignupBtn  = document.getElementById("closeSignupBtn");
    const signupEmailEl   = document.getElementById("signupEmail");
    const signupPassEl    = document.getElementById("signupPassword");
    const signupSubmitBtn = document.getElementById("signupSubmitBtn");
    const googleSignUpBtn = document.getElementById("googleSignUpBtn");
    const googleSignInBtn = document.getElementById("googleSignInBtn");
    const signOutBtn      = document.getElementById("signOutBtn");
    const analyzeBtn      = document.getElementById("analyzeBtn");
    const outputEl        = document.getElementById("output");

    // Toggle signup modal
    showSignupBtn.onclick = () => signupForm.classList.remove("hidden");
    closeSignupBtn.onclick = () => signupForm.classList.add("hidden");

    // Authentication flows
    googleSignInBtn.onclick = () => signInWithPopup(auth, provider).catch(err => alert(err.message));
    googleSignUpBtn.onclick = () => signInWithPopup(auth, provider).catch(err => alert(err.message));
    signupSubmitBtn.onclick = () => {
      createUserWithEmailAndPassword(auth, signupEmailEl.value, signupPassEl.value)
        .then(() => signupForm.classList.add("hidden"))
        .catch(err => alert(err.message));
    };
    signOutBtn.onclick = () => signOut(auth);

    // Auth state changes
    onAuthStateChanged(auth, user => {
      if (user) {
        showSignupBtn.classList.add("hidden");
        googleSignInBtn.classList.add("hidden");
        signOutBtn.classList.remove("hidden");
        signupForm.classList.add("hidden");
      } else {
        showSignupBtn.classList.remove("hidden");
        googleSignInBtn.classList.remove("hidden");
        signOutBtn.classList.add("hidden");
      }
    });

    // Helper for token
    async function getIdToken() {
      const user = auth.currentUser;
      if (!user) throw new Error("Please sign in first.");
      return await user.getIdToken();
    }

    // Analyzer logic
    let lastScene = "", lastResult = "";
    analyzeBtn.onclick = async () => {
      const scene   = document.getElementById("sceneInput").value.trim();
      const agreed  = document.getElementById("agreeCheckbox").checked;
      const saveOpt = document.getElementById("saveCheckbox").checked;
      if (!scene || !agreed) {
        outputEl.innerText = "⚠️ Enter a scene and accept terms.";
        outputEl.classList.remove("hidden");
        return;
      }
      if (scene === lastScene && lastResult) {
        outputEl.innerHTML = lastResult;
        outputEl.classList.remove("hidden");
        return;
      }
      outputEl.innerHTML = `<div class=\"flex items-center text-yellow-300\">Analyzing...</div>`;
      outputEl.classList.remove("hidden");
      let token;
      try { token = await getIdToken(); } catch (err) { alert(err.message); return; }
      try {
        const res = await fetch("https://api.scenecraft-ai.com/analyze", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token,
            "x-user-agreement": "true"
          },
          body: JSON.stringify({ scene, save: saveOpt })
        });
        const data = await res.json();
        lastResult = data.analysis ? `<strong>Analysis:</strong><br>${data.analysis}` : `❌ ${data.error||data.detail}`;
        outputEl.innerHTML = lastResult;
      } catch (e) { outputEl.innerText = "❌ Network error."; }
      lastScene = scene;
    };
  </script>
</body>
</html>
